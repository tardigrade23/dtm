<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Industry 4.0 | Self-Assessment · Tövsiyələr · Marketplace · Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#f6f8fb;--card:#fff;--ink:#223;--muted:#516076;--brand:#2563eb;--brand-2:#10b981;--border:#e5eaf0;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .container{max-width:1150px;margin:28px auto;padding:0 16px}
  .card{background:var(--card);border-radius:14px;box-shadow:0 8px 20px rgba(0,0,0,.06);padding:20px}
  .topbar{display:flex;gap:8px;justify-content:space-between;align-items:center;margin-bottom:12px}
  .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px auto 16px;justify-content:center}
  .tab-btn{border:1px solid var(--border);background:#fff;border-radius:999px;padding:10px 16px;cursor:pointer}
  .tab-btn.active{background:var(--brand);color:#fff;border-color:var(--brand)}
  .role-badge{border:1px solid var(--border);background:#fff;border-radius:999px;padding:6px 10px;font-size:12px;color:#334}
  section{display:none}
  section.active{display:block}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  @media (max-width:760px){.grid{grid-template-columns:1fr}}
  .q{display:grid;grid-template-columns:1fr 120px;gap:8px;align-items:center;background:#fff;border:1px solid var(--border);padding:10px;border-radius:10px}
  .cta{display:flex;gap:8px;margin:12px 0;flex-wrap:wrap}
  .btn{background:#fff;border:1px solid var(--border);padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .muted{color:var(--muted)}
  .stack{display:grid;grid-template-columns:360px 1fr;gap:16px}
  @media (max-width:900px){.stack{grid-template-columns:1fr}}
  .kpis{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
  .kpi{border:1px solid var(--border);border-radius:12px;padding:10px;background:#fff}
  .kpi .val{font-size:22px;font-weight:700}
  #progressBars .bar{background:#fff;border:1px solid var(--border);border-radius:10px;margin:6px 0;padding:8px}
  #progressBars .track{height:10px;background:#eef3fa;border-radius:6px;overflow:hidden;margin-top:6px}
  #progressBars .fill{height:10px;background:linear-gradient(90deg,var(--brand),var(--brand-2));width:0%}
  .vendor-card{display:grid;grid-template-columns:64px 1fr auto;gap:10px;align-items:center;border:1px solid var(--border);border-radius:12px;padding:10px;background:#fff}
  .vendor-logo{width:64px;height:64px;object-fit:contain}
  .vendor-info h4{margin:0 0 4px}
  .tag,.pill{display:inline-block;border:1px solid var(--border);padding:2px 8px;border-radius:999px;font-size:12px;margin:2px 4px 0 0;color:#334}
  .pill{background:#eef5ff;border-color:#d7e6ff}
  .market-controls{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
  .market-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  @media (max-width:900px){.market-grid{grid-template-columns:1fr}}
  .tips{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px}

  /* Validation / Toast */
  .input-error{ border-color:#ef4444 !important; box-shadow:0 0 0 2px rgba(239,68,68,.1); }
  .hint{ font-size:12px; color:#ef4444; margin:4px 0 0 0; display:none; }
  .toast{
    position:fixed; left:50%; bottom:24px; transform:translateX(-50%);
    background:#111; color:#fff; padding:10px 14px; border-radius:10px;
    opacity:0; pointer-events:none; transition:.25s;
  }
  .toast.show{ opacity:1; }

  /* Dashboard I/O Table */
  .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:12px;background:#fff}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;white-space:nowrap}
  th{background:#f3f6fc;font-weight:600}
  tr:last-child td{border-bottom:none}
  .status{padding:4px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px}
</style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="topbar">
        <div><strong>Industry 4.0 Marketplace · MVP</strong></div>
        <div class="right">
          <span id="roleBadge" class="role-badge">Rol: –</span>
          <button class="tab-btn active" data-tab="assessment" id="tab_assessment">Assessment</button>
          <button class="tab-btn" data-tab="recs" id="tab_recs">Recommendations</button>
          <button class="tab-btn" data-tab="market" id="tab_market">Marketplace</button>
          <button class="tab-btn" data-tab="dashboard" id="tab_dashboard">Dashboard</button>
          <button class="tab-btn" data-tab="admin" id="tab_admin" style="display:none">Admin</button>
        </div>
      </div>

      <!-- Assessment -->
      <section id="assessment" class="active">
        <p class="muted">Zəhmət olmasa suallara 1–5 arası cavab verin (1 = başlanğıc, 5 = ən yaxşı praktikaya yaxın).</p>
        <div class="grid" id="questions"></div>
        <div class="cta">
          <button class="btn primary" id="calcBtn">Nəticəni Hesabla</button>
          <button class="btn" id="resetBtn">Sıfırla</button>
        </div>
      </section>

      <!-- Recommendation -->
      <section id="recs">
        <div class="stack">
          <div><canvas id="radarChart" width="420" height="420"></canvas></div>
          <div>
            <div class="kpis">
              <div class="kpi"><h4>Ümumi Skor</h4><div class="val" id="overallScore">–</div></div>
              <div class="kpi"><h4>Güclü sahə</h4><div class="val" id="bestArea">–</div></div>
              <div class="kpi"><h4>Zəif sahə</h4><div class="val" id="worstArea">–</div></div>
            </div>
            <div id="progressBars" style="margin-top:10px"></div>

            <div class="recommendations" style="margin-top:14px">
              <h3>Tövsiyə Olunan Vendorlar</h3>
              <p class="muted">Zəif sahələr üzrə 5–10 vendor və hazır paketlər.</p>
              <div id="vendorList" class="market-grid"></div>
              <p class="muted" style="margin-top:8px">Qeyd: real uyğunluq üçün dərin sorğu və görüşlə təsdiqləyin.</p>
            </div>

            <div class="tips" style="margin-top:12px">
              <h3>Tez Başlanğıc İpuçları</h3>
              <ul id="quickTips"></ul>
            </div>
          </div>
        </div>
      </section>

      <!-- Marketplace -->
      <section id="market">
        <div class="market-controls">
          <input type="text" id="searchInput" placeholder="Vendor və ya həll axtar…"/>
          <select id="categoryFilter">
            <option value="">Bütün kateqoriyalar</option>
          </select>
        </div>
        <div id="marketGrid" class="market-grid"></div>
        <p class="muted">Vendor seçimi üçün kartdakı “Əlaqə” düyməsini sıxın – formadan birbaşa məktub göndərilir.</p>
      </section>

      <!-- Dashboard -->
      <section id="dashboard">
        <div class="kpis">
          <div class="kpi"><h4>Ümumi Skor</h4><div class="val" id="d_overall">–</div></div>
          <div class="kpi"><h4>Növbəti addım</h4><div class="val" id="d_step2">–</div></div>
          <div class="kpi"><h4>KPI</h4><div class="val" id="d_kpi">–</div></div>
        </div>

        <div id="d_suggestions" class="tips" style="margin-top:12px"></div>

        <!-- Dashboard I/O (CSV/JSON idxal/ixrac + sort) -->
        <div class="tips" style="margin-top:12px">
          <h3>Roadmap & Tapşırıqlar</h3>
          <div class="cta">
            <select id="tasksSortSel">
              <option value="">Sıralama: Standart</option>
              <option value="priority_desc">Prioritet (Yüksək→Aşağı)</option>
              <option value="priority_asc">Prioritet (Aşağı→Yüksək)</option>
              <option value="eta_asc">ETA (Tez→Gec)</option>
              <option value="category_asc">Kateqoriya (A→Z)</option>
              <option value="status_asc">Status (A→Z)</option>
            </select>

            <!-- bu düymələr yalnız Admin/Editor üçün görünəcək -->
            <button class="btn perm-admin-editor" id="exportCSV">CSV ixrac</button>
            <button class="btn perm-admin-editor" id="exportJSON">JSON ixrac</button>
            <label class="btn perm-admin-editor" for="importCSV">CSV idxal</label><input id="importCSV" type="file" accept=".csv" style="display:none">
            <label class="btn perm-admin-editor" for="importJSON">JSON idxal</label><input id="importJSON" type="file" accept=".json,application/json" style="display:none">
          </div>

          <div class="table-wrap">
            <table id="actionTable">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Kateqoriya</th>
                  <th>Tapşırıq</th>
                  <th>ETA</th>
                  <th>Owner</th>
                  <th>Status</th>
                  <th>Prioritet</th>
                </tr>
              </thead>
              <tbody id="actionTbody"></tbody>
            </table>
          </div>
          <p class="muted" style="margin-top:8px">Qeyd: Roadmap tövsiyələri hesablamadan sonra avtomatik “Tapşırıqlar”a seed olunur. CSV/JSON vasitəsilə yeniləmə yalnız Admin/Editor üçündür.</p>
        </div>
      </section>

      <!-- Admin -->
      <section id="admin">
        <h3>Admin</h3>
        <p class="muted">Burada rol seçimi və müəyyən ayarlar edilə bilər (MVP).</p>

        <div class="kpi"><strong>Son Hesablama:</strong> <span id="a_last">–</span></div>

        <h4 style="margin-top:14px">Role / Rol</h4>
        <div class="cta">
          <select id="roleSel">
            <option value="admin">Admin</option>
            <option value="editor">Editor / Moderator</option>
            <option value="requester">Sifarişçi (Sorğuçu)</option>
            <option value="vendor">Vendor</option>
          </select>
          <button class="btn primary" id="saveRoleBtn">Yadda saxla</button>
        </div>

        <div class="tips">
          <ul style="margin:0;padding-left:18px">
            <li><strong>Admin</strong>: bütün funksiyalar (Admin tab, idxal-ixrac, və s.).</li>
            <li><strong>Editor</strong>: Admin tab YOX; Dashboard idxal-ixrac VAR.</li>
            <li><strong>Sifarişçi/Sorğuçu</strong>: Assessment/Recs/Market/Dashboard görünür; Dashboard oxu rejimi (idxal-ixrac yoxdur).</li>
            <li><strong>Vendor</strong>: Market & Dashboard; Assessment/Recs gizlidir; oxu rejimi.</li>
          </ul>
        </div>
      </section>

      <footer>© Industry4Market MVP</footer>
    </div>
  </div>

  <!-- Contact Modal -->
  <div class="modal" id="contactModal" aria-hidden="true" style="position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:16px">
    <div class="box" style="max-width:520px;width:100%;background:#fff;border-radius:12px;padding:16px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>Vendorla əlaqə</h3>
        <button id="closeModal" class="btn">Bağla</button>
      </div>
      <div class="row" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
        <input id="f_name" placeholder="Adınız"/>
        <input id="f_email" placeholder="E-poçtunuz"/>
      </div>
      <div class="row" style="display:grid;grid-template-columns:1fr;gap:8px">
        <input id="f_vendor" placeholder="Vendor" readonly/>
        <textarea id="f_msg" rows="5" placeholder="Mesaj"></textarea>
      </div>
      <div class="cta" style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn primary" id="sendBtn">Göndər</button>
      </div>
    </div>
  </div>

<!-- Toast -->
<div id="toast" class="toast">Mesaj</div>

<script>
/* ===== CONFIG ===== */
const FORM_ENDPOINT = ""; // e.g. "https://formspree.io/f/xxxxxxx"
const ANALYTICS_ENDPOINT = ""; // optional endpoint

/* ===== Helpers ===== */
function $(q){return document.querySelector(q)}
function $all(q){return [...document.querySelectorAll(q)]}
function showToast(msg){
  const t = document.getElementById('toast'); if(!t) return;
  t.textContent = msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1800);
}

/* ===== Role model (MVP, localStorage) ===== */
const ROLE_KEY = 'i40_role';
const ROLES = {
  admin: {label:'Admin'},
  editor: {label:'Editor / Moderator'},
  requester: {label:'Sifarişçi (Sorğuçu)'},
  vendor: {label:'Vendor'}
};
function getRole(){ return localStorage.getItem(ROLE_KEY) || 'admin'; }
function setRole(r){ localStorage.setItem(ROLE_KEY, r); applyRolePermissions(); }
function updateRoleBadge(){
  const r = getRole(); const b = document.getElementById('roleBadge');
  b.textContent = 'Rol: ' + (ROLES[r]?.label || r);
}

/* İcazələr: tab görünürlüyü və düymə aktivliyi */
function applyRolePermissions(){
  const role = getRole();
  updateRoleBadge();

  // Tabs görünürlüyü
  // Admin tab: yalnız admin
  document.getElementById('tab_admin').style.display = (role==='admin') ? 'inline-block' : 'none';

  // Assessment/Recs: vendor üçün gizli
  const showAssess = role !== 'vendor';
  document.getElementById('tab_assessment').style.display = showAssess ? 'inline-block' : 'none';
  document.getElementById('tab_recs').style.display = showAssess ? 'inline-block' : 'none';
  document.getElementById('assessment').style.display = showAssess ? '' : 'none';
  document.getElementById('recs').style.display = showAssess ? '' : 'none';

  // Marketplace/Dashboard: hamıya açıq
  document.getElementById('tab_market').style.display = 'inline-block';
  document.getElementById('tab_dashboard').style.display = 'inline-block';

  // Dashboard idxal-ixrac düymələri: yalnız admin + editor
  const canIO = (role==='admin' || role==='editor');
  $all('.perm-admin-editor').forEach(el=>{
    el.style.display = canIO ? '' : 'none';
    if(el.tagName==='BUTTON') el.disabled = !canIO;
  });

  // Cari aktiv tab görünməz olduysa Dashboard-a keç
  const activeTab = document.querySelector('.tab-btn.active');
  if(activeTab && activeTab.style.display==='none'){
    document.getElementById('tab_dashboard').click();
  }
}

/* ===== Tabs ===== */
$all('.tab-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const t = btn.dataset.tab; if(!t) return;
    $all('.tab-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
    $all('section').forEach(s=>s.classList.remove('active')); document.getElementById(t).classList.add('active');
    track('tab', {tab:t});
  });
});

/* ===== DATA ===== */
const fields = ['Automation','Data & Analytics','Connectivity','People & Skills','Process & Governance'];

const i18n = {
  az: {
    questions: [
      'İstehsal proseslərində avtomatlaşdırma səviyyəniz nə dərəcədədir?',
      'Robototexnika / PLC tətbiqləriniz varmı?',
      'Məlumatların mərkəzləşdirilməsi və saxlanması necədir?',
      'BI dashboard və KPI-lar aktivdirmi?',
      'Avadanlıqlar/OT sistemi IT şəbəkəsinə etibarlı qoşulubmu?',
      'Standart protokollar (OPC UA/MQTT) istifadə olunurmu?',
      'Komandada rəqəmsal bacarıqların səviyyəsi necədir?',
      'Daxili “Digital Champion” / təlim proqramınız varmı?',
      'Proses xəritəsi və idarəetmə standartlarınız varmı?',
      'ROI və biznes-case-ləri izləmə mexanizminiz varmı?'
    ]
  }
};

const market = [
  {name:'RoboTech', email:'sales@robotech.example', category:'Automation', desc:'PLC/robotika pilot layihələri, OEE', tags:['PLC','Robot','OEE'], logo:'https://cdn.jsdelivr.net/gh/twitter/twemoji/assets/svg/1f916.svg'},
  {name:'DataWorks', email:'hello@dataworks.example', category:'Data & Analytics', desc:'ETL, Data Lake, BI dashboard', tags:['ETL','BI','KPI'], logo:'https://cdn.jsdelivr.net/gh/twitter/twemoji/assets/svg/1f4ca.svg'},
  {name:'EdgeLink', email:'info@edgelink.example', category:'Connectivity', desc:'OPC UA/MQTT gateway, real-time data', tags:['OPC UA','MQTT'], logo:'https://cdn.jsdelivr.net/gh/twitter/twemoji/assets/svg/1f5a5.svg'},
  {name:'SkillUp', email:'contact@skillup.example', category:'People & Skills', desc:'Upskilling, change mgmt', tags:['Training','Change'], logo:'https://cdn.jsdelivr.net/gh/twitter/twemoji/assets/svg/1f4da.svg'},
  {name:'GovPro', email:'team@govpro.example', category:'Process & Governance', desc:'SOP, proses xəritəsi, audit', tags:['SOP','Audit'], logo:'https://cdn.jsdelivr.net/gh/twitter/twemoji/assets/svg/1f4c4.svg'}
];

const vendorRecommendations = {
  'Automation':        [market[0]],
  'Data & Analytics':  [market[1]],
  'Connectivity':      [market[2]],
  'People & Skills':   [market[3]],
  'Process & Governance':[market[4]]
};

/* ===== Analytics helper ===== */
function track(ev, payload={}){
  const arr = JSON.parse(localStorage.getItem('i40_events')||'[]');
  arr.push({ev, payload, ts:new Date().toISOString()});
  localStorage.setItem('i40_events', JSON.stringify(arr));
  const a = document.getElementById('a_last'); if(a) a.textContent = new Date().toLocaleString();
}

/* ===== Assessment (build + validasiya/ toast) ===== */
function buildQuestions(){
  const box = document.getElementById('questions'); box.innerHTML = '';
  const list = i18n.az.questions;
  list.forEach((text, i)=>{
    const row = document.createElement('div'); row.className = 'q';
    row.innerHTML = `<label>${i+1}. ${text}</label><input type="number" name="q${i+1}" min="1" max="5">`;
    box.appendChild(row);
  });
}
function validationInputs(){ return Array.from(document.querySelectorAll('#assessment input[type=number]')); }
function ensureHints(inputs){
  inputs.forEach(inp=>{
    if(!inp.parentElement.querySelector('.hint')){
      const hint = document.createElement('div');
      hint.className = 'hint'; hint.style.display='none';
      hint.setAttribute('aria-live','polite');
      inp.parentElement.appendChild(hint);
    }
  });
}
function validateInputs(showErrors=false){
  const inputs = validationInputs(); let ok = true;
  inputs.forEach(inp=>{
    const val = parseInt(inp.value||'0',10);
    const valid = !isNaN(val) && val>=1 && val<=5;
    const hint = inp.parentElement.querySelector('.hint');
    if(!valid){
      ok=false;
      if(showErrors){
        inp.classList.add('input-error');
        if(hint){ hint.textContent='1–5 aralığında dəyər daxil edin'; hint.style.display='block'; }
      }
    }else{
      inp.classList.remove('input-error');
      if(hint){ hint.textContent=''; hint.style.display='none'; }
    }
  });
  if(!ok && showErrors){ showToast('Zəhmət olmasa 1–5 aralığında dəyərlər daxil edin'); }
  return ok;
}

/* Form dəyərləri oxu (1–5 clamp + UI sync) */
function getFormValues(){
  const vals = {};
  $all('#assessment input[type=number]').forEach(el=>{
    const v = parseInt(el.value||'0',10);
    vals[el.name] = isNaN(v)?0:Math.max(1,Math.min(5,v));
    el.value = vals[el.name]||'';
  });
  return vals;
}

/* Hesablamalar və UI */
let radar;
function calcScores(){
  const d = getFormValues();
  const arr = [
    ((d.q1||0)+(d.q2||0))/2,
    ((d.q3||0)+(d.q4||0))/2,
    ((d.q5||0)+(d.q6||0))/2,
    ((d.q7||0)+(d.q8||0))/2,
    ((d.q9||0)+(d.q10||0))/2
  ];
  const overall = (arr.reduce((a,b)=>a+b,0)/5)*20;
  return {arr, overall};
}
function renderRadar(arr){
  const ctx = document.getElementById('radarChart').getContext('2d');
  if(radar) radar.destroy();
  radar = new Chart(ctx,{
    type:'radar',
    data:{labels:fields, datasets:[{label:'Skor', data:arr}]},
    options:{responsive:true, scales:{r:{suggestedMin:0,suggestedMax:5,ticks:{stepSize:1}}}}
  });
}
function renderProgress(arr){
  const box = document.getElementById('progressBars'); box.innerHTML='';
  arr.forEach((v,i)=>{
    const wrap = document.createElement('div'); wrap.className='bar';
    wrap.innerHTML = `<div><strong>${fields[i]}</strong> — ${v.toFixed(1)}/5</div>
      <div class="track"><div class="fill" style="width:${(v/5*100).toFixed(0)}%"></div></div>`;
    box.appendChild(wrap);
  });
}
function updateKPIs(arr, overall){
  document.getElementById('overallScore').textContent = Math.round(overall)+'%';
  let bestIdx=0, worstIdx=0;
  arr.forEach((v,i)=>{ if(v>arr[bestIdx]) bestIdx=i; if(v<arr[worstIdx]) worstIdx=i; });
  document.getElementById('bestArea').textContent = fields[bestIdx];
  document.getElementById('worstArea').textContent = fields[worstIdx];
  document.getElementById('d_overall').textContent = Math.round(overall)+'%';
  document.getElementById('d_step2').textContent = fields[bestIdx];
  const target = Math.min(5, arr[worstIdx]+0.5); document.getElementById('d_kpi').textContent = fields[worstIdx]+' → '+target.toFixed(1);
}

/* Weighted Vendor Matching + % */
function pickVendors(arr){
  const weights = {
    'Automation':        1.0,
    'Data & Analytics':  1.2,
    'Connectivity':      1.1,
    'People & Skills':   0.9,
    'Process & Governance': 1.0
  };
  const scored = [];
  arr.forEach((score, idx)=>{
    const cat = fields[idx];
    const gap = Math.max(0, 5 - Number(score||0)); // ehtiyac
    const w = (weights[cat]||1) * gap;
    (vendorRecommendations[cat]||[]).forEach(v=>{
      const tagBoost = (v.tags&&v.tags.length) ? 0.2 : 0;
      scored.push({...v, category: cat, _score: w + tagBoost});
    });
  });
  const need = arr.some(s=>s<3);
  const overall = (arr.reduce((a,b)=>a+Number(b||0),0)/5)*20;
  const filtered = scored
    .filter(v => need || overall < 70)
    .sort((a,b)=>b._score - a._score)
    .slice(0,10)
    .map((v,i)=>({ ...v, match: Math.max(60, Math.min(95, Math.round(60 + v._score*6 - i))) }));
  return filtered;
}
function renderVendors(list, targetId){
  const box = document.getElementById(targetId); box.innerHTML='';
  if(list.length===0){ box.innerHTML = `<p class="muted">Hazırda dərhal boşluq görünmür. Vendor siyahısı sahə skoru &lt; 3 olduqda çıxır.</p>`; return;}
  list.forEach(v=>{
    const card=document.createElement('div'); card.className='vendor-card';
    card.innerHTML=`
      <img src="${v.logo}" alt="${v.name}" class="vendor-logo"/>
      <div class="vendor-info">
        <h4>${v.name} <span class="pill">${v.category}</span> <span class="pill">${v.match||''}%</span></h4>
        <p>${v.desc||''}</p>
        <div>${(v.tags||[]).map(t=>`<span class="tag">${t}</span>`).join('')}</div>
      </div>
      <button class="contact-btn" data-email="${v.email}" data-vendor="${v.name}">Əlaqə</button>
    `;
    box.appendChild(card);
  });
  box.querySelectorAll('.contact-btn').forEach(btn=>btn.addEventListener('click',()=>openContact(btn.dataset.vendor,btn.dataset.email)));
}
function quickTips(arr){
  const az = [
    ['Automation',['PLC/robotika üçün pilot xətt','OEE izləmə ilə başlanğıc']],
    ['Data & Analytics',['ETL + mərkəzi data saxlanması','3 KPI-lik BI dashboard']],
    ['Connectivity',['OPC UA/MQTT gateway quraşdırılması','Kritik aktivlərdən real-time data']],
    ['People & Skills',['2 günlük upskilling proqramı','“Digital Champion” təyinatı']],
    ['Process & Governance',['DX yol xəritəsinin sənədləşdirilməsi','ROI şablonu + aylıq icmal']]
  ];
  const out = [];
  arr.forEach((s,i)=>{ if(s<3){ out.push(...az[i][1]); } });
  if(out.length===0) out.push('İrəli mərhələ: advanced analytics və genişləndirilmiş IoT miqyaslama.');
  return out.map(x=>`<li>${x}</li>`).join('');
}

/* Roadmap Builder (Dashboard) + Tasks seed */
function buildRoadmap(arr){
  const items = [];
  const pack = [
    {cat:'Automation', steps:[
      'Pilot PLC/robot hüceyrəsi (4-6 həftə)',
      'OEE izləmə və itkilərin xəritələnməsi (2-3 həftə)'
    ]},
    {cat:'Data & Analytics', steps:[
      'ETL + mərkəzi data saxlanması (3-5 həftə)',
      '3 KPI-lik BI dashboard (2 həftə)'
    ]},
    {cat:'Connectivity', steps:[
      'OPC UA/MQTT gateway quraşdırılması (2-3 həftə)',
      'Kritik aktivlərdən real-time data (2 həftə)'
    ]},
    {cat:'People & Skills', steps:[
      '2 günlük upskilling proqramı',
      '“Digital Champion” təyinatı'
    ]},
    {cat:'Process & Governance', steps:[
      'DX yol xəritəsinin sənədləşdirilməsi',
      'ROI şablonu + aylıq icmal ritmi'
    ]}
  ];
  arr.forEach((s,i)=>{
    if(Number(s)<3){
      const cfg = pack[i];
      items.push({category:cfg.cat, action:cfg.steps[0], eta:'4-6 həftə', owner:'', status:'Planned', priority:3});
      items.push({category:cfg.cat, action:cfg.steps[1], eta:'2-3 həftə', owner:'', status:'Planned', priority:2});
    }
  });
  if(items.length===0){
    items.push({category:'Data & Analytics', action:'Advanced analytics miqyaslama', eta:'4-8 həftə', owner:'', status:'Planned', priority:2});
  }
  const cur = loadTasks();
  if(cur.length===0){ saveTasks(items); renderTasks(); }
  const sugHtml = items.map(it=>`<li><strong>${it.category}</strong>: ${it.action}</li>`).join('');
  const d = document.getElementById('d_suggestions');
  if(d){ d.innerHTML = '<ul>'+sugHtml+'</ul>'; }
}

/* ===== Dashboard I/O: CSV/JSON + Sort (localStorage) ===== */
const TASKS_KEY = 'i40_tasks';
function loadTasks(){ try{ return JSON.parse(localStorage.getItem(TASKS_KEY)||'[]'); }catch(e){ return []; } }
function saveTasks(arr){ localStorage.setItem(TASKS_KEY, JSON.stringify(arr)); }
function sortTasks(list){
  const mode = document.getElementById('tasksSortSel')?.value||'';
  const arr = [...list];
  const by = (k,dir='asc') => (a,b)=>{
    const av=(a[k]??''); const bv=(b[k]??'');
    if(typeof av==='number' && typeof bv==='number') return dir==='asc'? av-bv : bv-av;
    return dir==='asc'? String(av).localeCompare(String(bv)) : String(bv).localeCompare(String(av));
  };
  if(mode==='priority_desc') arr.sort(by('priority','desc'));
  else if(mode==='priority_asc') arr.sort(by('priority','asc'));
  else if(mode==='eta_asc') arr.sort(by('eta','asc'));
  else if(mode==='category_asc') arr.sort(by('category','asc'));
  else if(mode==='status_asc') arr.sort(by('status','asc'));
  return arr;
}
function renderTasks(){
  const tbody = document.getElementById('actionTbody'); if(!tbody) return;
  const items = sortTasks(loadTasks());
  tbody.innerHTML = items.map((t,i)=>`
    <tr>
      <td>${i+1}</td>
      <td>${t.category||''}</td>
      <td>${t.action||''}</td>
      <td>${t.eta||''}</td>
      <td>${t.owner||''}</td>
      <td><span class="status">${t.status||''}</span></td>
      <td>${t.priority!=null?t.priority:''}</td>
    </tr>
  `).join('');
}
/* Export */
function exportCSV(){
  const rows = [['category','action','eta','owner','status','priority']];
  loadTasks().forEach(t=>rows.push([t.category||'',t.action||'',t.eta||'',t.owner||'',t.status||'',t.priority!=null?t.priority:'']));
  const csv = rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='tasks.csv'; a.click(); URL.revokeObjectURL(a.href);
  showToast('CSV ixrac olundu');
}
function exportJSON(){
  const blob = new Blob([JSON.stringify(loadTasks(),null,2)],{type:'application/json'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='tasks.json'; a.click(); URL.revokeObjectURL(a.href);
  showToast('JSON ixrac olundu');
}
/* Import */
async function importCSV(file){
  const text = await file.text();
  const lines = text.split('\n').map(l=>l.trim()).filter(Boolean);
  const hdr = lines.shift().split(',').map(s=>s.replace(/^"|"$/g,'').replace(/""/g,'"').toLowerCase());
  const idx = k=>hdr.indexOf(k);
  const items = lines.map(line=>{
    const cells = line.split(',').map(s=>s.replace(/^"|"$/g,'').replace(/""/g,'"'));
    return {
      category: cells[idx('category')]||'',
      action:   cells[idx('action')]||'',
      eta:      cells[idx('eta')]||'',
      owner:    cells[idx('owner')]||'',
      status:   cells[idx('status')]||'',
      priority: Number(cells[idx('priority')]||'')||''
    };
  });
  saveTasks([...items]); renderTasks(); showToast('CSV idxal olundu');
}
async function importJSON(file){
  try{
    const text = await file.text();
    const arr = JSON.parse(text);
    if(!Array.isArray(arr)) throw new Error('JSON array olmalıdır');
    const norm = arr.map(t=>({
      category: t.category||'',
      action: t.action||'',
      eta: t.eta||'',
      owner: t.owner||'',
      status: t.status||'',
      priority: (t.priority!=null && !isNaN(Number(t.priority))) ? Number(t.priority) : ''
    }));
    saveTasks(norm); renderTasks(); showToast('JSON idxal olundu');
  }catch(e){
    showToast('JSON format xətası');
  }
}

/* Marketplace */
function renderMarket(list){
  const box = document.getElementById('marketGrid'); box.innerHTML='';
  list.forEach(v=>{
    const card = document.createElement('div'); card.className='vendor-card';
    card.innerHTML = `
      <img src="${v.logo}" alt="${v.name}" class="vendor-logo"/>
      <div class="vendor-info">
        <h4>${v.name} <span class="pill">${v.category}</span></h4>
        <p>${v.desc||''}</p>
        <div>${(v.tags||[]).map(t=>`<span class="tag">${t}</span>`).join('')}</div>
      </div>
      <button class="contact-btn" data-email="${v.email}" data-vendor="${v.name}">Əlaqə</button>
    `;
    box.appendChild(card);
  });
  box.querySelectorAll('.contact-btn').forEach(btn=>btn.addEventListener('click',()=>openContact(btn.dataset.vendor,btn.dataset.email)));
}
function applyMarketFilters(){
  const q = document.getElementById('searchInput').value.toLowerCase().trim();
  const c = document.getElementById('categoryFilter').value;
  const filtered = market.filter(m=>{
    const inCat = !c || m.category===c;
    const inText = !q || [m.name,m.desc||'',...(m.tags||[])].join(' ').toLowerCase().includes(q);
    return inCat && inText;
  });
  renderMarket(filtered);
}

/* Contact Modal */
const modal = document.getElementById('contactModal');
const f_vendor = document.getElementById('f_vendor');
const f_name = document.getElementById('f_name');
const f_email = document.getElementById('f_email');
const f_msg = document.getElementById('f_msg');

function openContact(vendor,email){
  f_vendor.value = vendor;
  f_msg.value = `Salam ${vendor},\nRəqəmsal transformasiya üzrə aşağıdakı mövzu üçün yardım lazımdır...\n\nHörmətlə,`;
  modal.style.display='flex'; modal.setAttribute('aria-hidden','false');
  modal.setAttribute('role','dialog'); modal.setAttribute('aria-modal','true');
  f_name.focus();
  function esc(e){ if(e.key==='Escape'){ close(); } }
  function close(){
    modal.style.display='none'; modal.setAttribute('aria-hidden','true');
    document.removeEventListener('keydown', esc);
  }
  document.getElementById('closeModal').onclick = close;
  document.addEventListener('keydown', esc);
}
document.getElementById('sendBtn').addEventListener('click', ()=>{
  const to = market.find(v=>v.name===f_vendor.value)?.email || '';
  const subject = encodeURIComponent('Sorğu: Industry4Market');
  const body = encodeURIComponent(`${f_msg.value}\n\n${f_name.value} · ${f_email.value}`);
  location.href = `mailto:${to}?subject=${subject}&body=${body}`;
  track('contact_mailto', {to});
});

/* === Auto-persist cavablar === */
const ANSWERS_KEY = 'i40_answers';
function saveAnswers(){
  const map = {};
  validationInputs().forEach(inp=>{
    if (inp.name) map[inp.name] = inp.value;
  });
  try{ localStorage.setItem(ANSWERS_KEY, JSON.stringify(map)); }catch(e){}
}
function restoreAnswers(){
  const raw = localStorage.getItem(ANSWERS_KEY);
  if(!raw) return;
  let map = {};
  try{ map = JSON.parse(raw)||{}; }catch(e){ return; }
  validationInputs().forEach(inp=>{
    if (map[inp.name] != null) inp.value = map[inp.name];
  });
}
// auto-save
document.addEventListener('input', (e)=>{
  if(e.target && e.target.closest('#assessment') && e.target.type==='number'){ saveAnswers(); }
});

/* === Init === */
(function init(){
  // Role UI init
  const sel = document.getElementById('roleSel');
  if(sel){ sel.value = getRole(); }
  applyRolePermissions();

  const qp = new URLSearchParams(location.search);
  if(qp.get('admin')==='1' || JSON.parse(localStorage.getItem('i40_events')||'[]').length>0){
    document.getElementById('tab_admin').style.display='inline-block';
  }

  const catSel = document.getElementById('categoryFilter'); fields.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; catSel.appendChild(o); });
  document.getElementById('searchInput').addEventListener('input', applyMarketFilters);
  document.getElementById('categoryFilter').addEventListener('change', applyMarketFilters);
  renderMarket(market); applyMarketFilters();

  buildQuestions();
  restoreAnswers();
  ensureHints(validationInputs());

  // canlı yoxlama
  validationInputs().forEach(inp=>{
    inp.setAttribute('min','1'); inp.setAttribute('max','5'); inp.setAttribute('step','1');
    inp.addEventListener('keydown',(e)=>{ if(['e','E','+','-','.'].includes(e.key)) e.preventDefault(); });
    inp.addEventListener('input', ()=>{
      const v = parseInt(inp.value||'0',10);
      const hint = inp.parentElement.querySelector('.hint');
      const valid = !isNaN(v)&&v>=1&&v<=5;
      if(!valid){ inp.classList.add('input-error'); if(hint){hint.textContent='1–5 aralığında dəyər'; hint.style.display='block';}}
      else{ inp.classList.remove('input-error'); if(hint){hint.textContent=''; hint.style.display='none';} }
    });
    inp.addEventListener('blur', ()=>{
      let v = parseInt(inp.value||'0',10);
      if(isNaN(v)){ inp.value=''; return; }
      v = Math.max(1,Math.min(5,v)); inp.value=String(v);
      const hint = inp.parentElement.querySelector('.hint');
      inp.classList.remove('input-error'); if(hint){hint.textContent=''; hint.style.display='none';}
    });
  });

  // Dashboard I/O handlers
  const canIO = (getRole()==='admin' || getRole()==='editor');
  if(document.getElementById('tasksSortSel'))
    document.getElementById('tasksSortSel').addEventListener('change', ()=>{ renderTasks(); track('tasks_sort', {mode:document.getElementById('tasksSortSel').value}); });
  if(canIO){
    document.getElementById('exportCSV').addEventListener('click', exportCSV);
    document.getElementById('exportJSON').addEventListener('click', exportJSON);
    document.getElementById('importCSV').addEventListener('change', e=>{ const f=e.target.files[0]; if(f) importCSV(f); e.target.value=''; });
    document.getElementById('importJSON').addEventListener('change', e=>{ const f=e.target.files[0]; if(f) importJSON(f); e.target.value=''; });
  }

  // Calc
  document.getElementById('calcBtn').addEventListener('click', ()=>{
    if(!validateInputs(true)) return;
    const {arr, overall} = calcScores();
    renderRadar(arr); renderProgress(arr); updateKPIs(arr,overall);
    buildRoadmap(arr); // həm də tasks seed
    renderVendors(pickVendors(arr), 'vendorList');
    document.getElementById('quickTips').innerHTML = quickTips(arr);
    document.getElementById('d_suggestions').innerHTML = '<ul>'+quickTips(arr)+'</ul>';
    localStorage.setItem('i40_scores', JSON.stringify({arr,overall}));
    document.querySelector('#tab_recs').click();
    track('calc', {overall:Math.round(overall)});
  });

  document.getElementById('resetBtn').addEventListener('click', ()=>{
    localStorage.removeItem('i40_scores'); localStorage.removeItem('i40_answers'); localStorage.removeItem('i40_tasks');
    document.getElementById('questions').querySelectorAll('input').forEach(i=>i.value='');
    document.getElementById('progressBars').innerHTML='';
    document.getElementById('overallScore').textContent='–';
    document.getElementById('bestArea').textContent='–';
    document.getElementById('worstArea').textContent='–';
    document.getElementById('vendorList').innerHTML='';
    document.getElementById('quickTips').innerHTML='';
    document.getElementById('d_suggestions').innerHTML='';
    renderTasks();
    showToast('Form & Tapşırıqlar sıfırlandı');
  });

  const saved = JSON.parse(localStorage.getItem('i40_scores')||'null');
  if(saved){
    renderRadar(saved.arr); renderProgress(saved.arr); updateKPIs(saved.arr,saved.overall);
    renderVendors(pickVendors(saved.arr), 'vendorList');
    document.getElementById('quickTips').innerHTML = quickTips(saved.arr);
    document.getElementById('d_suggestions').innerHTML = '<ul>'+quickTips(saved.arr)+'</ul>';
  }
  renderTasks();

  // Admin: rol saxlama
  const saveBtn = document.getElementById('saveRoleBtn');
  if(saveBtn){
    saveBtn.addEventListener('click', ()=>{
      const r = document.getElementById('roleSel').value;
      setRole(r);
      showToast('Rol yadda saxlanıldı');
    });
  }

  track('init', {ts:Date.now()});
})();
</script>
</body>
</html>
